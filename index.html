<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shiva Plásticos — Relatório de Ensaio PVC-U</title>

  <!-- Bibliotecas para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="light only">
  <meta name="theme-color" content="#E1262D">
</head>
<body>
  <a class="sr-only sr-only-focusable" href="#conteudo">Pular para o conteúdo</a>

  <!-- TOPBAR -->
  <header class="topbar" role="banner">
    <div class="brand" aria-label="Shiva Conexoes">
      <img src="chiva.png" alt="Shiva Plásticos" />
      <div class="brand-text">
        <span class="brand-title">Relatórios de Ensaio</span>
        <span class="brand-sub">PVC-U • Conexões</span>
      </div>
    </div>

    <div class="actions" role="group" aria-label="Ações do relatório">
      <button id="btnToggleAside" class="secundario" type="button" title="Mostrar/ocultar lista">☰ Lista</button>
      <button id="btnNovo" type="button" title="Criar relatório em branco">Novo</button>
      <button id="btnSalvar" type="button" title="Salvar no navegador">Salvar</button>
      <button id="btnExportar" type="button" title="Exportar este relatório em JSON">Exportar JSON</button>
      <button id="btnPDF" type="button" title="Gerar PDF com layout de texto">PDF (texto)</button>
      <button id="btnPDFhtml" type="button" title="Gerar PDF a partir do layout da página">PDF (layout)</button>
      <label class="import" for="inputImportar" title="Importar um arquivo JSON">
        Importar JSON
        <input type="file" id="inputImportar" accept="application/json" />
      </label>
      <button id="btnImprimir" type="button" title="Impressão do layout (sistema do navegador)">Imprimir</button>
    </div>
  </header>

  <main class="layout" id="app" role="main">
    <div id="ariaLive" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <!-- Lateral: Relatórios -->
    <aside class="lista-relatorios" aria-label="Relatórios salvos">
      <div class="aside-head">
        <h2>Relatórios</h2>
        <input id="filtroLista" placeholder="Buscar..." type="search" aria-label="Buscar em relatórios salvos" />
      </div>
      <ul id="listaRelatorios" aria-live="polite"></ul>
    </aside>

    <!-- Conteúdo -->
    <section class="conteudo" id="conteudo" tabindex="-1">
      <form id="formRelatorio" novalidate>
        <!-- 1. Identificação -->
        <fieldset>
          <legend>1. Identificação do Relatório</legend>
          <div class="grid">
            <label>Nº do Relatório
              <input required name="numeroRelatorio" autocomplete="off" />
            </label>
            <label>Revisão
              <input name="revisao" autocomplete="off" />
            </label>
            <label>Data de emissão
              <input required name="dataEmissao" type="date" />
            </label>
            <label>Responsável Técnico
              <input required name="responsavelTecnico" autocomplete="name" />
            </label>
            <label>Laboratório
              <input required name="laboratorio" autocomplete="organization" />
            </label>
          </div>

          <!-- 1.a Normas de referência — DUAL SELECTOR COM BUSCA -->
          <div class="combo" role="group" aria-label="Normas de referência">
            <label class="small" for="buscaNorma">Normas de referência</label>
            <div class="combo-grid">
              <!-- Coluna esquerda: busca + disponíveis -->
              <div>
                <input id="buscaNorma" type="search" placeholder="Pesquisar norma (ex.: ABNT, ISO, EN...)"
                       aria-label="Buscar normas disponíveis" />
                <select id="normasSelect" multiple size="10" aria-label="Normas disponíveis para seleção">
                  <!-- opções iniciais visíveis para já permitir pesquisa antes do JS carregar -->
                  <option>ABNT NBR 5648:2018</option>
                  <option>ABNT NBR 8219</option>
                  <option>ABNT NBR NM 82</option>
                  <option>EN 62321-3-1:2014</option>
                  <option>ABNT NBR NM 84</option>
                  <option>ABNT NBR 8218</option>
                  <option>ABNT NBR 14264</option>
                  <option>ABNT NBR 7371</option>
                </select>
                <div class="inline" style="margin-top:8px">
                  <button type="button" id="btnAddSelecionadas" class="secundario" title="Adicionar selecionadas à lista da direita">Adicionar ➜</button>
                </div>
              </div>

              <!-- Coluna direita: escolhidas (entram no relatório) -->
              <div>
                <label class="small" for="normasEscolhidas">Selecionadas (estas aparecerão no relatório)</label>
                <select id="normasEscolhidas" multiple size="10" aria-label="Normas selecionadas"></select>
                <div class="inline" style="margin-top:8px; gap:8px">
                  <button type="button" id="btnRemoverEscolhidas" class="secundario danger" title="Remover da lista de selecionadas">Remover</button>
                  <button type="button" id="btnMoverCima" class="secundario" title="Mover para cima">↑</button>
                  <button type="button" id="btnMoverBaixo" class="secundario" title="Mover para baixo">↓</button>
                </div>
                <p class="hint">Dica: use Ctrl/Cmd para selecionar múltiplas normas. Dê dois cliques numa norma para mover entre as listas.</p>
              </div>
            </div>

            <!-- Adição rápida de norma personalizada -->
            <div class="addbox" style="margin-top:10px">
              <label class="small" for="novaNorma">Adicionar norma personalizada</label>
              <input id="novaNorma" placeholder="Ex.: ABNT NBR 13292:2024" />
              <div class="inline">
                <button type="button" id="btnAddNorma" class="secundario" title="Adicionar e selecionar">Adicionar</button>
                <button type="button" id="btnDelNorma" class="secundario danger" title="Excluir selecionadas da lista da direita">Excluir selecionada</button>
              </div>
              <p class="hint">As normas adicionadas aqui ficam disponíveis para outros relatórios neste navegador.</p>
            </div>
          </div>
        </fieldset>

        <!-- 2. Amostras -->
        <fieldset>
          <legend>2. Identificação da(s) Amostra(s)</legend>
          <div id="amostras"></div>
          <button type="button" class="secundario" id="btnAddAmostra">+ Adicionar amostra</button>
        </fieldset>

        <!-- 3. Objetivo -->
        <fieldset>
          <legend>3. Objetivo do Ensaio</legend>
          <textarea name="objetivo" rows="3"
            placeholder="Apresentar resultados obtidos nos ensaios realizados em conexões de PVC-U, visando verificar a conformidade com as normas técnicas aplicáveis."></textarea>
        </fieldset>

        <!-- 4. Métodos -->
        <legend>4. Métodos e Materiais Empregados</legend>
        <p class="hint">Cadastro interno (não sai no relatório). Preencha os campos e clique em <strong>Incluir</strong> para adicionar à grade. Use <strong>Alterar</strong> ou <strong>Excluir</strong> nas linhas.</p>

        <!-- Formulário de inclusão/edição rápida -->
        <div class="grid" style="margin-bottom:12px">
          <label>Método / Descrição
            <input id="metMetodo" placeholder="Ex.: Determinação de resistência hidrostática (ABNT NBR 13292:2024)" />
          </label>

          <label>Norma / Referência
            <input id="metNorma" placeholder="Ex.: ABNT NBR 13292:2024, ISO 3126:2019" />
          </label>

          <label>Equipamento
            <input id="metEquip" placeholder="Ex.: Máquina de ensaio hidrostático XYZ; Calibrador digital" />
          </label>

          <label>Materiais
            <input id="metMateriais" placeholder="Ex.: Água destilada; Termostato; Conexões PVC-U DN50" />
          </label>

          <label>Procedimento (resumo)
            <input id="metProced" placeholder="Ex.: Pressurizar a 1,5 x PN por 60 min a 23 °C" />
          </label>

          <label>Critério / Requisito
            <input id="metCriterio" placeholder="Ex.: Sem vazamentos/rupturas; Desvio ≤ 2%" />
          </label>

          <label>Unidade
            <input id="metUnidade" placeholder="Ex.: MPa, bar, %, mm" />
          </label>

          <label class="inline" style="align-items:flex-end">
            <input type="checkbox" id="metAplicado" />
            <span>Aplicado?</span>
          </label>
        </div>

        <div class="inline" style="gap:8px; margin-bottom:10px">
          <button type="button" id="btnAddMetodo" class="secundario">Incluir</button>
          <button type="button" id="btnLimparMetodo" class="secundario">Limpar</button>
        </div>

        <!-- Grade (tabela) -->
        <div class="tabela-wrap">
          <table class="tabela" id="tblMetodos">
            <thead>
              <tr>
                <th style="min-width:220px">Método / Descrição</th>
                <th>Norma</th>
                <th>Equipamento</th>
                <th>Materiais</th>
                <th>Procedimento</th>
                <th>Critério</th>
                <th>Unid.</th>
                <th>Aplic.</th>
                <th aria-label="Ações" style="min-width:140px">Ações</th>
              </tr>
            </thead>
            <tbody>
              <!-- linhas geradas via JS -->
            </tbody>
          </table>
        </div>

        <p class="hint" style="margin-top:10px">
          Dica: use descrições objetivas; detalhes extensos podem ir para anexos. Na impressão/PDF este cadastro pode ser ocultado com a classe <code>no-print</code> no fieldset.
        </p>

        <!-- 5. Resultados -->
        <fieldset>
          <legend>5. Resultados dos Ensaios</legend>
          <div class="tabela-wrap">
            <table class="tabela" id="tblResultados">
              <caption class="sr-only">Tabela de resultados dos ensaios</caption>
              <thead>
                <tr>
                  <th>Ensaio</th>
                  <th>Resultado obtido</th>
                  <th>Requisito normativo</th>
                  <th>Conformidade</th>
                  <th aria-label="Ações"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <button type="button" class="secundario" id="btnAddResultado">+ Adicionar resultado</button>
        </fieldset>

        <!-- 6. Discussão -->
        <fieldset>
          <legend>6. Discussão dos Resultados</legend>
          <textarea name="discussao" rows="4"
            placeholder="Análise comparativa entre os resultados obtidos e os critérios estabelecidos nas normas de referência."></textarea>
        </fieldset>

        <!-- 7. Conclusão -->
        <fieldset>
          <legend>7. Conclusão</legend>
          <div class="grid">
            <label class="inline"><input type="radio" name="statusConclusao" value="Conforme" checked />Conforme</label>
            <label class="inline"><input type="radio" name="statusConclusao" value="Não conforme" />Não conforme</label>
          </div>
          <textarea name="conclusaoObs" rows="3"
            placeholder="Observações complementares e referências à norma."></textarea>
        </fieldset>

        <!-- 8. Anexos -->
        <fieldset>
          <legend>8. Anexos</legend>
          <div class="grid">
            <label>Certificados de calibração (URLs; separe por “;”)
              <input name="anexosCertificados" placeholder="https://...; https://..." inputmode="url" />
            </label>
            <label>Planilhas/Gráficos (URLs; separe por “;”)
              <input name="anexosPlanilhas" placeholder="https://...; https://..." inputmode="url" />
            </label>
            <label>Fotos das amostras (URLs; separe por “;”)
              <input name="anexosFotos" placeholder="https://...; https://..." inputmode="url" />
            </label>
          </div>
        </fieldset>

        <!-- 9. Imagens -->
        <fieldset>
          <legend>9. Imagens</legend>
          <div id="imagens"></div>
          <button type="button" class="secundario" id="btnAddImagem">+ Adicionar imagem</button>
          <p class="hint">Cole uma URL de imagem ou selecione um arquivo. Inclua legenda e texto alternativo.</p>
        </fieldset>

        <!-- 10. Tabelas adicionais -->
        <fieldset>
          <legend>10. Tabelas adicionais</legend>
          <div id="tabelasExtras"></div>
          <button type="button" class="secundario" id="btnAddTabela">+ Adicionar tabela</button>
        </fieldset>

        <input type="hidden" name="id" />
      </form>
    </section>
  </main>

  <footer class="rodape" role="contentinfo">
    <small>© <span id="ano"></span> Shiva Plásticos — Relatórios digitais.</small>
  </footer>


  <!-- Seu JS (versão revisada que te enviei) -->
  <script src="script.js" defer></script>
</body>
</html>
